<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asterix Uploader - أداة رفع الصور</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .max {
      max-height: 100px;
      overflow-y: auto;
    }

    .table tr td:nth-child(2),
    .table tr td:nth-child(3) {
      overflow-y: auto;
    }

    .table tr td:nth-child(2)::-webkit-scrollbar,
    .table tr td:nth-child(3)::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }

    .table tr td:nth-child(2)::-webkit-scrollbar-track,
    .table tr td:nth-child(3)::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .table tr td:nth-child(2)::-webkit-scrollbar-thumb,
    .table tr td:nth-child(3)::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .table tr td:nth-child(2)::-webkit-scrollbar-thumb:hover,
    .table tr td:nth-child(3)::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .file-upload {
      border: 2px dashed #6c757d;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload:hover {
      border-color: #0d6efd;
      background: rgba(13, 110, 253, 0.05);
    }

    .file-upload-icon {
      font-size: 2rem;
      color: #0d6efd;
      margin-bottom: 10px;
    }

    .loader {
      display: none;
      margin: 20px auto;
      border: 6px solid #e9ecef;
      border-top: 6px solid #0d6efd;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .btn-sm {
      padding: 5px 10px;
    }

    .copy-icon {
      cursor: pointer;
      color: #0d6efd;
      transition: color 0.3s;
    }

    .copy-icon:hover {
      color: #0056b3;
    }

    .modal-content {
      font-family: 'Tajawal', sans-serif;
      border-radius: 12px;
    }

    .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }

    .modal-footer {
      border-top: 1px solid #dee2e6;
    }

    .instructions {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 10px;
    }
  </style>
</head>

<body class="p-md-4">
  <div class="container">
    <header class="text-center mb-4">
      <h1 class="display-6">أداة رفع الصور من Asterix</h1>
      <p class="text-muted">ارفع صورك بسهولة وشاركها خلال دقائق</p>
    </header>

    <div class="row">
      <div class="col-md-8 mx-auto">
        <div class="mb-3">
          <label for="projectName" class="form-label"><i class="fas fa-folder me-2"></i>اسم المشروع (لجلب الصور
            فقط)</label>
          <input type="text" class="form-control" id="projectName" placeholder="أدخل اسم المشروع لعرض الصور">
        </div>
        <div class="mb-3">
          <button class="btn btn-info w-100 mb-3" id="loadImagesButton"><i class="fas fa-search me-2"></i>جلب
            الصور</button>
        </div>
        <div class="mb-3">
          <div class="instructions">يرجى اختيار مجلد الصور. سيتطلب المتصفح إذنًا للوصول إلى الملفات، اضغط "Upload" في
            النافذة
            التي تظهر.</div>
          <label class="form-label"><i class="fas fa-folder-open me-2"></i>اختر مجلد الصور</label>
          <div class="file-upload" id="folderUploadArea">
            <div class="file-upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="file-upload-text">انقر لاختيار المجلد أو اسحب وأسقطه هنا</div>
          </div>
          <input type="file" id="folderUpload" webkitdirectory directory multiple style="display: none;"
            accept="image/*">
          <div class="max mt-3" id="fileList"></div>
        </div>
        <!-- Removed uploadButton since upload is now automatic -->
        <div class="progress mb-3" id="progressContainer" style="display: none;">
          <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0"
            aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="text-center mb-3 loader" id="loader"></div>
        <div class="alert alert-info d-none" id="projectNameBox"></div>
        <div class="alert alert-info d-none" id="logBox"></div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12">
        <h3><i class="fas fa-images me-2"></i>الصور المرفوعة</h3>
        <div class="mb-3">
          <button class="btn btn-success mb-3 me-2" id="addImageButton" style="display: none;"><i
              class="fas fa-plus me-2"></i>إضافة صور</button>
          <button class="btn btn-danger mb-3" id="deleteProjectButton" style="display: none;"><i
              class="fas fa-trash-alt me-2"></i>حذف المشروع</button>
        </div>
        <table class="table table-striped table-bordered">
          <thead>
            <tr class="row">
              <th class="col-3">معاينة</th>
              <th class="col-3">اسم الصورة</th>
              <th class="col-2">الرابط</th>
              <th class="col-4">الإجراءات</th>
            </tr>
          </thead>
          <tbody id="imageTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel">تأكيد العملية</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
          </div>
          <div class="modal-body" id="confirmModalMessage">
            <!-- Message will be set dynamically -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
            <button type="button" class="btn btn-danger" id="confirmModalButton">تأكيد</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center mt-4">
      <p class="text-muted">جميع الحقوق محفوظة © 2025 Asterix Uploader</p>
    </footer>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBCRDvXJSZSOWfmd7jneq4lvsdT94oTG7c",
      authDomain: "sign-language-6273a.firebaseapp.com",
      projectId: "sign-language-6273a",
      storageBucket: "sign-language-6273a.appspot.com",
      messagingSenderId: "504758894593",
      appId: "1:504758894593:web:76664a2f549484cd508000",
      measurementId: "G-3Q45BSCEXK"
    };

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (error) {
      console.error('خطأ في تهيئة Firebase:', error);
      document.getElementById('logBox').classList.remove('d-none');
      document.getElementById('logBox').classList.add('alert-danger');
      document.getElementById('logBox').innerHTML = `<i class="fas fa-times-circle"></i> خطأ في تهيئة Firebase: ${error.message}`;
    }
    const storage = firebase.storage();
    const db = firebase.firestore();

    // DOM Elements
    const folderUploadArea = document.getElementById('folderUploadArea');
    const folderUploadInput = document.getElementById('folderUpload');
    const fileList = document.getElementById('fileList');
    const loadImagesButton = document.getElementById('loadImagesButton');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const loader = document.getElementById('loader');
    const logBox = document.getElementById('logBox');
    const projectNameBox = document.getElementById('projectNameBox');
    const imageTable = document.getElementById('imageTable');
    const projectNameInput = document.getElementById('projectName');
    const addImageButton = document.getElementById('addImageButton');
    const deleteProjectButton = document.getElementById('deleteProjectButton');

    // Global variable to store current project
    let currentProject = null;

    // Initialize Bootstrap Modal
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'), {
      backdrop: 'static',
      keyboard: false
    });
    const confirmModalMessage = document.getElementById('confirmModalMessage');
    const confirmModalButton = document.getElementById('confirmModalButton');

    // Show Confirmation Modal and Return Promise
    function showConfirmModal(message) {
      return new Promise((resolve) => {
        confirmModalMessage.textContent = message;
        confirmModalButton.disabled = false;
        confirmModal.show();

        const onConfirm = () => {
          confirmModalButton.disabled = true;
          resolve(true);
          confirmModal.hide();
          confirmModalButton.removeEventListener('click', onConfirm);
          document.getElementById('confirmModal').removeEventListener('hidden.bs.modal', onCancel);
        };

        const onCancel = () => {
          resolve(false);
          confirmModal.hide();
          confirmModalButton.removeEventListener('click', onConfirm);
          document.getElementById('confirmModal').removeEventListener('hidden.bs.modal', onCancel);
        };

        confirmModalButton.addEventListener('click', onConfirm);
        document.getElementById('confirmModal').addEventListener('hidden.bs.modal', onCancel);
      });
    }

    // Drag and Drop
    folderUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      folderUploadArea.style.borderColor = '#0d6efd';
      folderUploadArea.style.backgroundColor = 'rgba(13, 110, 253, 0.05)';
    });

    folderUploadArea.addEventListener('dragleave', () => {
      folderUploadArea.style.borderColor = '#6c757d';
      folderUploadArea.style.backgroundColor = '';
    });

    folderUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      folderUploadArea.style.borderColor = '#6c757d';
      folderUploadArea.style.backgroundColor = '';
      folderUploadInput.files = e.dataTransfer.files;
      updateFileList();
    });

    folderUploadArea.addEventListener('click', () => {
      folderUploadInput.click();
    });

    folderUploadInput.addEventListener('change', updateFileList);

    function updateFileList() {
      const files = folderUploadInput.files;
      fileList.innerHTML = '';

      // Define valid image extensions
      const imageExtensions = /\.(jpg|jpeg|png|gif|bmp|webp)$/i;

      // Filter only image files in the root folder
      const imageFiles = Array.from(files).filter(file => {
        // Check if file is an image
        const isImage = imageExtensions.test(file.name);
        // Check if file is in the root folder (no subfolders)
        const isRootFile = file.webkitRelativePath.split('/').length === 2;
        return isImage && isRootFile;
      });

      if (imageFiles.length > 0) {
        fileList.innerHTML = '<ul class="list-group">';
        for (let i = 0; i < Math.min(imageFiles.length, 10); i++) {
          fileList.innerHTML += `
        <li class="list-group-item">
          <i class="fas fa-image me-2"></i>${imageFiles[i].name}
        </li>`;
        }
        if (imageFiles.length > 10) {
          fileList.innerHTML += `<li class="list-group-item">و ${imageFiles.length - 10} صور أخرى...</li>`;
        }
        fileList.innerHTML += '</ul>';
        folderUploadArea.querySelector('.file-upload-text').textContent = 'تم اختيار المجلد بنجاح، جاري الرفع...';
        uploadFolder(imageFiles); // Pass filtered image files to upload
      } else {
        fileList.innerHTML = '';
        folderUploadArea.querySelector('.file-upload-text').textContent = 'انقر لاختيار المجلد أو اسحب وأسقطه هنا';
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-warning');
        logBox.innerHTML = '<i class="fas fa-exclamation-circle"></i> لم يتم العثور على صور في المجلد الرئيسي.';
      }
    }

    // Copy to Clipboard
    function copyToClipboard(text, elementId) {
      const emId = document.getElementById(elementId);
      if (!emId) return;
      navigator.clipboard.writeText(text).then(() => {
        const tooltip = document.createElement('div');
        tooltip.innerHTML = 'تم النسخ!';
        tooltip.style.position = 'absolute';
        tooltip.style.background = '#28a745';
        tooltip.style.color = 'white';
        tooltip.style.padding = '5px 10px';
        tooltip.style.borderRadius = '4px';
        tooltip.style.fontSize = '12px';
        const copyIcons = document.querySelectorAll('.copy-icon');
        const copyIcon = Array.from(copyIcons).find(icon => icon.getAttribute('onclick')?.includes(`'${text}'`));
        if (copyIcon) {
          const rect = copyIcon.getBoundingClientRect();
          emId.appendChild(tooltip);
          setTimeout(() => tooltip.remove(), 2000);
        }
      }).catch((error) => {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ في النسخ: ${error.message}`;
      });
    }

    // Generate unique project name
    function generateUniqueProjectName() {
      return uuidv4();
    }

    // Generate or retrieve shortened URL using TinyURL
    async function getOrCreateShortUrl(project, imageName, originalUrl) {
      const shortUrlDocRef = db.collection('shortUrls').doc(`${project}_${imageName}`);
      const doc = await shortUrlDocRef.get();

      if (doc.exists) {
        return doc.data().shortUrl;
      } else {
        const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(originalUrl)}`);
        if (!response.ok) {
          throw new Error('فشل في إنشاء رابط مختصر عبر TinyURL');
        }
        const shortUrl = await response.text();

        await shortUrlDocRef.set({
          project,
          imageName,
          originalUrl,
          shortUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        return shortUrl;
      }
    }

    // Load Images in Table
    async function loadImages(project) {
      if (!project) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = '<i class="fas fa-exclamation-circle"></i> يرجى إدخال اسم المشروع.';
        addImageButton.style.display = 'none';
        deleteProjectButton.style.display = 'none';
        return;
      }

      imageTable.innerHTML = '';
      loader.style.display = 'block';
      try {
        const listRef = storage.ref(`projects/${project}/`);
        const list = await listRef.listAll();
        if (list.items.length === 0) {
          logBox.classList.remove('d-none');
          logBox.classList.add('alert-info');
          logBox.innerHTML = '<i class="fas fa-info-circle"></i> لا توجد صور في هذا المشروع.';
          addImageButton.style.display = 'none';
          deleteProjectButton.style.display = 'none';
          return;
        }
        for (const [index, item] of list.items.entries()) {
          const originalUrl = await item.getDownloadURL();
          const shortUrl = await getOrCreateShortUrl(project, item.name, originalUrl);
          const row = document.createElement('tr');
          row.classList.add('row');
          row.innerHTML = `
            <td class='col-3'><img src="${originalUrl}" alt="${item.name}" class="img-fluid"></td>
            <td class='col-3'>${item.name}</td>
            <td id='shortUrl-${index}' class='col-2'>
              <a href="${shortUrl}" target="_blank">${shortUrl}</a>
              <i class="fas fa-copy ms-2 copy-icon" onclick="copyToClipboard('${shortUrl}', 'shortUrl-${index}')"></i>
            </td>
            <td class='col-4'>
              <button class="btn btn-warning btn-sm me-2" onclick="editImage('${item.name}', '${project}')"><i class="fas fa-edit"></i> تعديل</button>
              <button class="btn btn-danger btn-sm" onclick="deleteImage('${item.name}', '${project}')"><i class="fas fa-trash"></i> حذف</button>
            </td>
          `;
          imageTable.appendChild(row);
        }
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-success');
        logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم جلب الصور بنجاح!`;
        currentProject = project;
        addImageButton.style.display = 'block';
        deleteProjectButton.style.display = 'block';
      } catch (error) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
        addImageButton.style.display = 'none';
        deleteProjectButton.style.display = 'none';
      } finally {
        loader.style.display = 'none';
      }
    }

    // Upload Folder
    async function uploadFolder(imageFiles) {
      // If no image files are provided, use folderUploadInput.files (fallback for unchanged calls)
      const files = imageFiles || Array.from(folderUploadInput.files).filter(file => {
        const imageExtensions = /\.(jpg|jpeg|png|gif|bmp|webp)$/i;
        const isRootFile = file.webkitRelativePath.split('/').length === 2;
        return imageExtensions.test(file.name) && isRootFile;
      });

      if (files.length === 0) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = '<i class="fas fa-exclamation-circle"></i> يرجى اختيار مجلد يحتوي على صور.';
        return;
      }

      const project = generateUniqueProjectName();

      loader.style.display = 'block';
      progressContainer.style.display = 'block';
      logBox.classList.remove('d-none');
      logBox.classList.remove('alert-danger');
      logBox.classList.add('alert-info');
      logBox.innerHTML = '<i class="fas fa-upload"></i> جاري تحضير الصور للرفع...';

      try {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const storagePath = `projects/${project}/${file.name}`;
          const storageRef = storage.ref(storagePath);
          const uploadTask = storageRef.put(file);

          uploadTask.on(
            'state_changed',
            (snapshot) => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              progressBar.style.width = `${progress}%`;
              logBox.innerHTML = `<i class="fas fa-upload"></i> جاري رفع ${file.name} (${i + 1}/${files.length})`;
            },
            (error) => {
              throw new Error(`فشل في رفع ${file.name}: ${error.message}`);
            }
          );

          await uploadTask;
          const originalUrl = await storageRef.getDownloadURL();
          await getOrCreateShortUrl(project, file.name, originalUrl);
        }

        projectNameBox.classList.remove('d-none');
        projectNameBox.classList.add('alert-success');
        projectNameBox.innerHTML = `<i class="fas fa-check-circle"></i> تم رفع الصور بنجاح! اسم المشروع الخاص بك: <strong id="projectId">${project}</strong><i id='copyico' class="fas fa-copy ms-2 copy-icon" onclick="copyToClipboard('${project}', 'copyico')"></i>. استخدم هذا الاسم لجلب الصور.`;
        logBox.classList.remove('alert-info');
        logBox.classList.add('alert-success');
        logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم رفع الصور بنجاح!`;
        await loadImages(project);
      } catch (error) {
        logBox.classList.remove('alert-info');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
        projectNameBox.classList.add('d-none');
      } finally {
        loader.style.display = 'none';
        progressContainer.style.display = 'none';
      }
    }

    // Delete Image
    async function deleteImage(imageName, project) {
      const confirmed = await showConfirmModal(`هل أنت متأكد من حذف ${imageName}؟`);
      if (!confirmed) return;

      try {
        const imageRef = storage.ref(`projects/${project}/${imageName}`);
        await imageRef.delete();
        const shortUrlDocRef = db.collection('shortUrls').doc(`${project}_${imageName}`);
        await shortUrlDocRef.delete();
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-success');
        logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم حذف ${imageName} بنجاح!`;
        await loadImages(project);
      } catch (error) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
      }
    }

    // Delete Project (All Images and Short URLs)
    async function deleteProject() {
      if (!currentProject) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = '<i class="fas fa-exclamation-circle"></i> يرجى جلب مشروع أولاً.';
        return;
      }

      const confirmed = await showConfirmModal(`هل أنت متأكد من حذف جميع الصور والروابط المختصرة للمشروع ${currentProject}؟ هذا الإجراء لا يمكن التراجع عنه.`);
      if (!confirmed) return;

      loader.style.display = 'block';
      logBox.classList.remove('d-none');
      logBox.classList.remove('alert-danger');
      logBox.classList.add('alert-info');
      logBox.innerHTML = '<i class="fas fa-trash-alt"></i> جاري حذف المشروع...';

      try {
        const listRef = storage.ref(`projects/${currentProject}/`);
        const list = await listRef.listAll();
        const deleteImagePromises = list.items.map(async (item) => {
          await item.delete();
        });
        await Promise.all(deleteImagePromises);

        const snapshot = await db.collection('shortUrls').where('project', '==', currentProject).get();
        const deleteShortUrlPromises = snapshot.docs.map(async (doc) => {
          await doc.ref.delete();
        });
        await Promise.all(deleteShortUrlPromises);

        imageTable.innerHTML = '';
        logBox.classList.remove('alert-info');
        logBox.classList.add('alert-success');
        logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم حذف المشروع ${currentProject} وجميع صوره وروابطه بنجاح!`;
        currentProject = null;
        addImageButton.style.display = 'none';
        deleteProjectButton.style.display = 'none';
        projectNameInput.value = '';
      } catch (error) {
        logBox.classList.remove('alert-info');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ في حذف المشروع: ${error.message}`;
      } finally {
        loader.style.display = 'none';
      }
    }

    // Edit Image
    async function editImage(imageName, project) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const newFile = e.target.files[0];
        if (newFile) {
          try {
            const imageRef = storage.ref(`projects/${project}/${imageName}`);
            await imageRef.delete();
            const storageRef = storage.ref(`projects/${project}/${imageName}`);
            const uploadTask = storageRef.put(newFile);

            uploadTask.on(
              'state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                logBox.classList.remove('d-none');
                logBox.classList.add('alert-info');
                logBox.innerHTML = `<i class="fas fa-upload"></i> جاري رفع الصورة الجديدة... (${progress.toFixed(2)}%)`;
              },
              (error) => {
                throw new Error(`فشل في رفع الصورة الجديدة: ${error.message}`);
              }
            );

            await uploadTask;
            const originalUrl = await storageRef.getDownloadURL();
            await getOrCreateShortUrl(project, imageName, originalUrl);
            logBox.classList.remove('alert-info');
            logBox.classList.add('alert-success');
            logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم تعديل ${imageName} بنجاح!`;
            await loadImages(project);
          } catch (error) {
            logBox.classList.remove('alert-info');
            logBox.classList.add('alert-danger');
            logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
          }
        }
      };
      input.click();
    }

    // Add New Image to Existing Project
    async function addNewImage() {
      if (!currentProject) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = `<i class="fas fa-exclamation-circle"></i> يرجى جلب الصور أولاً.`;
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.onchange = async (e) => {
        const files = e.target.files;
        if (files.length > 0) {
          try {
            loader.style.display = 'block';
            progressContainer.style.display = 'block';
            logBox.classList.remove('d-none');
            logBox.classList.add('alert-info');
            logBox.innerHTML = '<i class="fas fa-upload"></i> جاري رفع الصور الجديدة...';

            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              const storagePath = `projects/${currentProject}/${file.name}`;
              const storageRef = storage.ref(storagePath);
              const uploadTask = storageRef.put(file);

              uploadTask.on(
                'state_changed',
                (snapshot) => {
                  const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                  progressBar.style.width = `${progress}%`;
                  logBox.innerHTML = `<i class="fas fa-upload"></i> جاري رفع ${file.name} (${i + 1}/${files.length})`;
                },
                (error) => {
                  throw new Error(`فشل في رفع ${file.name}: ${error.message}`);
                }
              );

              await uploadTask;
              const originalUrl = await storageRef.getDownloadURL();
              await getOrCreateShortUrl(currentProject, file.name, originalUrl);
            }

            logBox.classList.remove('alert-info');
            logBox.classList.add('alert-success');
            logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم إضافة الصور الجديدة بنجاح!`;
            await loadImages(currentProject);
          } catch (error) {
            logBox.classList.remove('alert-info');
            logBox.classList.add('alert-danger');
            logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
          } finally {
            loader.style.display = 'none';
            progressContainer.style.display = 'none';
          }
        }
      };
      input.click();
    }

    // Load Images Button Event
    loadImagesButton.addEventListener('click', () => {
      const project = projectNameInput.value.trim();
      loadImages(project);
    });

    // Add Image Button Event
    addImageButton.addEventListener('click', addNewImage);

    // Delete Project Button Event
    deleteProjectButton.addEventListener('click', deleteProject);
  </script>
</body>

</html>