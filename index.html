<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asterix Uploader - أداة رفع الصور</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    .max {
      max-height: 100px;
      overflow-y: auto;
    }
    .file-upload {
      border: 2px dashed #6c757d;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .file-upload:hover {
      border-color: #0d6efd;
      background: rgba(13, 110, 253, 0.05);
    }
    .file-upload-icon {
      font-size: 2rem;
      color: #0d6efd;
      margin-bottom: 10px;
    }
    .loader {
      display: none;
      margin: 20px auto;
      border: 6px solid #e9ecef;
      border-top: 6px solid #0d6efd;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .table img {
      max-width: 100px;
      height: auto;
    }
    .btn-sm {
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="text-center mb-4">
      <h1 class="display-6">أداة رفع الصور من Asterix</h1>
      <p class="text-muted">ارفع صورك بسهولة وشاركها خلال دقائق</p>
    </header>

    <div class="row">
      <div class="col-md-8 mx-auto">
        <div class="mb-3">
          <label for="projectName" class="form-label"><i class="fas fa-folder me-2"></i>اسم المشروع</label>
          <input type="text" class="form-control" id="projectName" placeholder="مثال: my-photos">
        </div>
        <div class="mb-3">
          <label for="layerName" class="form-label"><i class="fas fa-layer-group me-2"></i>اسم الطبقة</label>
          <input type="text" class="form-control" id="layerName" placeholder="مثال: main">
        </div>
        <div class="mb-3">
          <button class="btn btn-info w-100 mb-3" id="loadImagesButton"><i class="fas fa-search me-2"></i>جلب الصور</button>
        </div>
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-folder-open me-2"></i>اختر مجلد الصور</label>
          <div class="file-upload" id="folderUploadArea">
            <div class="file-upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="file-upload-text">انقر لاختيار المجلد أو اسحب وأسقطه هنا</div>
          </div>
          <input type="file" id="folderUpload" webkitdirectory directory multiple style="display: none;" accept="image/*">
          <div class="max mt-3" id="fileList"></div>
        </div>
        <button class="btn btn-primary w-100 mb-3" id="uploadButton"><i class="fas fa-rocket me-2"></i>رفع الصور</button>
        <div class="progress mb-3" id="progressContainer" style="display: none;">
          <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="text-center mb-3 loader" id="loader"></div>
        <div class="alert alert-info d-none" id="logBox"></div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12">
        <h3><i class="fas fa-images me-2"></i>الصور المرفوعة</h3>
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>معاينة</th>
              <th>اسم الصورة</th>
              <th>الرابط</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody id="imageTable"></tbody>
        </table>
      </div>
    </div>

    <footer class="text-center mt-4">
      <p class="text-muted">جميع الحقوق محفوظة © 2025 Asterix Uploader</p>
    </footer>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBCRDvXJSZSOWfmd7jneq4lvsdT94oTG7c",
      authDomain: "sign-language-6273a.firebaseapp.com",
      projectId: "sign-language-6273a",
      storageBucket: "sign-language-6273a.appspot.com",
      messagingSenderId: "504758894593",
      appId: "1:504758894593:web:76664a2f549484cd508000",
      measurementId: "G-3Q45BSCEXK"
    };

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (error) {
      console.error('خطأ في تهيئة Firebase:', error);
      document.getElementById('logBox').classList.remove('d-none');
      document.getElementById('logBox').classList.add('alert-danger');
      document.getElementById('logBox').innerHTML = `<i class="fas fa-times-circle"></i> خطأ في تهيئة Firebase: ${error.message}`;
    }
    const storage = firebase.storage();

    // DOM Elements
    const folderUploadArea = document.getElementById('folderUploadArea');
    const folderUploadInput = document.getElementById('folderUpload');
    const fileList = document.getElementById('fileList');
    const uploadButton = document.getElementById('uploadButton');
    const loadImagesButton = document.getElementById('loadImagesButton');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const loader = document.getElementById('loader');
    const logBox = document.getElementById('logBox');
    const imageTable = document.getElementById('imageTable');
    const projectNameInput = document.getElementById('projectName');
    const layerNameInput = document.getElementById('layerName');

    // Drag and Drop
    folderUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      folderUploadArea.style.borderColor = '#0d6efd';
      folderUploadArea.style.backgroundColor = 'rgba(13, 110, 253, 0.05)';
    });

    folderUploadArea.addEventListener('dragleave', () => {
      folderUploadArea.style.borderColor = '#6c757d';
      folderUploadArea.style.backgroundColor = '';
    });

    folderUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      folderUploadArea.style.borderColor = '#6c757d';
      folderUploadArea.style.backgroundColor = '';
      folderUploadInput.files = e.dataTransfer.files;
      updateFileList();
    });

    folderUploadArea.addEventListener('click', () => {
      folderUploadInput.click();
    });

    folderUploadInput.addEventListener('change', updateFileList);

    function updateFileList() {
      const files = folderUploadInput.files;
      fileList.innerHTML = '';
      if (files.length > 0) {
        fileList.innerHTML = '<ul class="list-group">';
        for (let i = 0; i < Math.min(files.length, 10); i++) {
          fileList.innerHTML += `
            <li class="list-group-item">
              <i class="fas fa-image me-2"></i>${files[i].webkitRelativePath.split('/').slice(1).join('/')}
            </li>`;
        }
        if (files.length > 10) {
          fileList.innerHTML += `<li class="list-group-item">و ${files.length - 10} صور أخرى...</li>`;
        }
        fileList.innerHTML += '</ul>';
        folderUploadArea.querySelector('.file-upload-text').textContent = 'تم اختيار المجلد بنجاح';
      } else {
        fileList.innerHTML = '';
        folderUploadArea.querySelector('.file-upload-text').textContent = 'انقر لاختيار المجلد أو اسحب وأسقطه هنا';
      }
    }

    // Load Images in Table
    async function loadImages(project, layer) {
      if (!project || !layer) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = '<i class="fas fa-exclamation-circle"></i> يرجى إدخال اسم المشروع والطبقة.';
        return;
      }

      imageTable.innerHTML = '';
      loader.style.display = 'block';
      try {
        const listRef = storage.ref(`projects/${project}/${layer}/`);
        const list = await listRef.listAll();
        if (list.items.length === 0) {
          logBox.classList.remove('d-none');
          logBox.classList.add('alert-info');
          logBox.innerHTML = '<i class="fas fa-info-circle"></i> لا توجد صور في هذا المجلد.';
          return;
        }
        for (const item of list.items) {
          const url = await item.getDownloadURL();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><img src="${url}" alt="${item.name}" class="img-fluid"></td>
            <td>${item.name}</td>
            <td><a href="${url}" target="_blank">imgUrl</a></td>
            <td>
              <button class="btn btn-warning btn-sm me-2" onclick="editImage('${item.name}', '${project}', '${layer}')"><i class="fas fa-edit"></i> تعديل</button>
              <button class="btn btn-danger btn-sm" onclick="deleteImage('${item.name}', '${project}', '${layer}')"><i class="fas fa-trash"></i> حذف</button>
            </td>
          `;
          imageTable.appendChild(row);
        }
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-success');
        logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم جلب الصور بنجاح!`;
      } catch (error) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
      } finally {
        loader.style.display = 'none';
      }
    }

    // Upload Folder
    async function uploadFolder() {
      const project = projectNameInput.value.trim();
      const layer = layerNameInput.value.trim();
      const files = folderUploadInput.files;

      if (!project || !layer || files.length === 0) {
        logBox.classList.remove('d-none');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = '<i class="fas fa-exclamation-circle"></i> يرجى إدخال اسم المشروع والطبقة واختيار مجلد.';
        return;
      }

      uploadButton.disabled = true;
      loader.style.display = 'block';
      progressContainer.style.display = 'block';
      logBox.classList.remove('d-none');
      logBox.classList.remove('alert-danger');
      logBox.classList.add('alert-info');
      logBox.innerHTML = '<i class="fas fa-upload"></i> جاري تحضير الملفات للرفع...';

      try {
        const baseFolder = files[0].webkitRelativePath.split("/")[0];
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const relativePath = file.webkitRelativePath.split("/").slice(1).join("/");
          const storagePath = `projects/${project}/${layer}/${relativePath}`;

          const storageRef = storage.ref(storagePath);
          const uploadTask = storageRef.put(file);

          uploadTask.on(
            'state_changed',
            (snapshot) => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              progressBar.style.width = `${progress}%`;
              logBox.innerHTML = `<i class="fas fa-upload"></i> جاري رفع ${file.name} (${i + 1}/${files.length})`;
            },
            (error) => {
              throw new Error(`فشل في رفع ${file.name}: ${error.message}`);
            }
          );

          await uploadTask;
        }

        logBox.classList.remove('alert-info');
        logBox.classList.add('alert-success');
        logBox.innerHTML = '<i class="fas fa-check-circle"></i> تم رفع الصور بنجاح!';
        await loadImages(project, layer);
      } catch (error) {
        logBox.classList.remove('alert-info');
        logBox.classList.add('alert-danger');
        logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
      } finally {
        uploadButton.disabled = false;
        loader.style.display = 'none';
        progressContainer.style.display = 'none';
      }
    }

    // Delete Image
    async function deleteImage(imageName, project, layer) {
      if (confirm(`هل أنت متأكد من حذف ${imageName}؟`)) {
        try {
          const imageRef = storage.ref(`projects/${project}/${layer}/${imageName}`);
          await imageRef.delete();
          logBox.classList.remove('d-none');
          logBox.classList.add('alert-success');
          logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم حذف ${imageName} بنجاح!`;
          await loadImages(project, layer);
        } catch (error) {
          logBox.classList.remove('d-none');
          logBox.classList.add('alert-danger');
          logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
        }
      }
    }

    // Edit Image
    async function editImage(imageName, project, layer) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const newFile = e.target.files[0];
        if (newFile) {
          try {
            const imageRef = storage.ref(`projects/${project}/${layer}/${imageName}`);
            await imageRef.delete();

            const storageRef = storage.ref(`projects/${project}/${layer}/${imageName}`);
            const uploadTask = storageRef.put(newFile);

            uploadTask.on(
              'state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                logBox.classList.remove('d-none');
                logBox.classList.add('alert-info');
                logBox.innerHTML = `<i class="fas fa-upload"></i> جاري رفع الصورة الجديدة... (${progress.toFixed(2)}%)`;
              },
              (error) => {
                throw new Error(`فشل في رفع الصورة الجديدة: ${error.message}`);
              }
            );

            await uploadTask;
            logBox.classList.remove('alert-info');
            logBox.classList.add('alert-success');
            logBox.innerHTML = `<i class="fas fa-check-circle"></i> تم تعديل ${imageName} بنجاح!`;
            await loadImages(project, layer);
          } catch (error) {
            logBox.classList.remove('alert-info');
            logBox.classList.add('alert-danger');
            logBox.innerHTML = `<i class="fas fa-times-circle"></i> خطأ: ${error.message}`;
          }
        }
      };
      input.click();
    }

    // Load Images Button Event
    loadImagesButton.addEventListener('click', () => {
      const project = projectNameInput.value.trim();
      const layer = layerNameInput.value.trim();
      loadImages(project, layer);
    });

    // Upload Button Event
    uploadButton.addEventListener('click', uploadFolder);
  </script>
</body>
</html>